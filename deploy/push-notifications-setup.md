# Настройка Web Push уведомлений

Эта инструкция поможет вам настроить систему push-уведомлений для АСО Store.

## Предварительные требования

- HTTPS соединение (обязательно для Web Push)
- Node.js 18+ 
- PostgreSQL база данных
- Современный браузер с поддержкой Push API

## Шаг 1: Генерация VAPID ключей

VAPID (Voluntary Application Server Identification) ключи необходимы для аутентификации вашего сервера при отправке push-уведомлений.

```bash
# Перейдите в папку backend
cd backend

# Убедитесь, что установлены зависимости
npm install

# Сгенерируйте VAPID ключи
node scripts/generate-vapid-keys.js
```

Скрипт выведет ключи в консоль. Сохраните их в безопасном месте!

## Шаг 2: Настройка переменных окружения

### Backend (.env)

Добавьте сгенерированные ключи в файл `backend/.env`:

```env
# Web Push Notifications
VAPID_PUBLIC_KEY=ваш_публичный_ключ_из_шага_1
VAPID_PRIVATE_KEY=ваш_приватный_ключ_из_шага_1
VAPID_SUBJECT=mailto:admin@aso-store.ru
```

⚠️ **Важно**: Замените `admin@aso-store.ru` на реальный email администратора сайта.

### Frontend (.env.local)

Добавьте публичный ключ в файл `frontend/.env.local`:

```env
# Web Push Notifications
NEXT_PUBLIC_VAPID_PUBLIC_KEY=ваш_публичный_ключ_из_шага_1
```

## Шаг 3: Миграция базы данных

Примените миграцию для создания таблицы `PushSubscription`:

```bash
cd backend
npx prisma migrate dev --name add_push_subscriptions
```

Или для production:

```bash
cd backend
npx prisma migrate deploy
```

## Шаг 4: Создание иконок для уведомлений

Создайте две PNG иконки и поместите их в `frontend/public/`:

1. **icon-192x192.png** - основная иконка (192x192 пикселей)
   - Будет отображаться в уведомлении
   - Рекомендуется использовать логотип вашего магазина

2. **badge-72x72.png** - маленькая иконка (72x72 пикселей)
   - Отображается как badge на мобильных устройствах
   - Обычно монохромная версия логотипа

## Шаг 5: Проверка HTTPS

Web Push работает только через HTTPS. Убедитесь, что ваш сайт доступен по HTTPS:

- Для локальной разработки можно использовать `localhost` (браузеры разрешают Web Push на localhost)
- Для production обязателен валидный SSL сертификат

## Шаг 6: Тестирование

### 1. Запустите приложение:

```bash
npm run dev
```

### 2. Откройте чат:

- Зайдите на сайт и откройте чат (кнопка в правом нижнем углу)
- Система автоматически предложит включить уведомления

### 3. Протестируйте уведомления:

Для менеджера:
```bash
# Откройте админ панель в другом браузере/вкладке
# Зайдите в раздел "Чаты"
# Отправьте сообщение клиенту
```

Для клиента:
```bash
# Отправьте сообщение в чат
# Дождитесь ответа менеджера
```

### 4. Проверьте endpoint для тестирования:

```bash
curl -X POST http://localhost:4000/api/notifications/test/ENDPOINT_URL
```

## Настройки браузера

### Chrome/Edge:
1. Откройте `chrome://settings/content/notifications`
2. Убедитесь, что ваш сайт не заблокирован
3. При необходимости добавьте сайт в разрешенные

### Firefox:
1. Откройте `about:preferences#privacy`
2. Найдите раздел "Уведомления"
3. Проверьте настройки для вашего сайта

### Safari (iOS 16.4+):
1. Добавьте сайт на главный экран как PWA
2. Откройте настройки уведомлений в iOS
3. Разрешите уведомления для вашего PWA

## Отладка

### Проверка Service Worker:

1. Откройте DevTools (F12)
2. Перейдите в Application → Service Workers
3. Убедитесь, что `sw.js` зарегистрирован и активен

### Проверка подписок:

```sql
-- Посмотреть все активные подписки
SELECT * FROM "PushSubscription" WHERE "isActive" = true;

-- Проверить подписки пользователя
SELECT * FROM "PushSubscription" WHERE "userId" = 'USER_ID';
```

### Логи сервера:

```bash
# Backend логи покажут попытки отправки уведомлений
cd backend
npm run start:dev
```

## Частые проблемы

### "Notification permission denied"
- Пользователь заблокировал уведомления
- Решение: Попросите пользователя разрешить уведомления в настройках браузера

### "Failed to send notification: 410"
- Подписка больше не действительна
- Решение: Система автоматически деактивирует такие подписки

### Уведомления не приходят
1. Проверьте HTTPS соединение
2. Убедитесь, что VAPID ключи правильно настроены
3. Проверьте, что Service Worker активен
4. Посмотрите логи backend на наличие ошибок

### "Registration failed - no active Service Worker"
- Service Worker не загружен
- Решение: Проверьте, что файл `sw.js` доступен по адресу `/sw.js`

## Production рекомендации

1. **Безопасность**:
   - Никогда не коммитьте VAPID приватный ключ
   - Используйте переменные окружения для всех ключей

2. **Мониторинг**:
   - Логируйте все ошибки отправки уведомлений
   - Отслеживайте количество активных подписок
   - Мониторьте процент доставки уведомлений

3. **Оптимизация**:
   - Регулярно очищайте недействительные подписки
   - Используйте батчинг для массовых рассылок
   - Настройте TTL (Time To Live) для уведомлений

4. **UX рекомендации**:
   - Не запрашивайте разрешение сразу при входе на сайт
   - Объясните пользователю, зачем нужны уведомления
   - Предоставьте возможность легко отключить уведомления

## Дополнительные настройки

### Кастомизация уведомлений:

Отредактируйте `frontend/public/sw.js` для изменения:
- Звука уведомления
- Вибрации
- Времени отображения
- Действий (кнопок) в уведомлении

### Расширенные возможности:

1. **Группировка уведомлений**:
   - Используйте `tag` для группировки похожих уведомлений

2. **Тихие часы**:
   - Добавьте настройку времени, когда не отправлять уведомления

3. **Приоритеты**:
   - Настройте разные типы уведомлений с разными приоритетами

## Полезные ссылки

- [Web Push Protocol](https://tools.ietf.org/html/rfc8030)
- [Push API MDN](https://developer.mozilla.org/en-US/docs/Web/API/Push_API)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [web-push библиотека](https://github.com/web-push-libs/web-push)