# Progress Log

## Выполненные задачи

### Улучшения формы добавления/редактирования товара (2025-01-24)

#### Реализованные функции:

1. ✅ **Добавлено поле старой цены (oldPrice)**
   - Добавлено поле oldPrice в модель Product в Prisma схеме
   - Обновлены DTO для создания и обновления товара
   - Поле oldPrice включено в ProductDto для отображения скидок
   - Обновлен ProductsService для обработки старой цены

2. ✅ **Создана модель ProductImage для изображений товаров**
   - Новая модель в Prisma с полями: url, alt, sortOrder, isMain
   - Отдельная таблица для гибкого управления изображениями
   - Поддержка множественных изображений с сортировкой
   - Возможность указать главное изображение товара

3. ✅ **Реализована загрузка изображений товаров**
   - Создан ProductImagesController с эндпоинтами:
     - POST /products/:productId/images/upload - загрузка файла
     - POST /products/:productId/images - добавление по URL
     - GET /products/:productId/images - получение всех изображений
     - PATCH /products/:productId/images/reorder - изменение порядка
     - PATCH /products/:productId/images/:id - обновление изображения
     - DELETE /products/:productId/images/:id - удаление изображения
   - ProductImagesService для управления изображениями
   - Загрузка файлов через multer в папку /uploads/products
   - Ограничение размера файла: 10MB
   - Поддержка форматов: JPEG, PNG, GIF, WebP

#### Технические детали:

- Обновлена Prisma схема с новыми полями и моделью
- Созданы DTO: CreateProductImageDto, UpdateProductImageDto, ProductImageDto, ReorderProductImagesDto
- Интеграция с существующей системой авторизации (ADMIN, MANAGER)
- Обновлен ProductsService для включения productImages в запросы
- Статические файлы доступны через /uploads/products/

### Улучшения системы промокодов (2025-06-21)

#### Реализованные функции:

1. ✅ **Проверка истечения срока действия промокода при оформлении заказа**
   - Добавлена повторная валидация промокода перед созданием заказа в `orders.service.ts`
   - Промокод проверяется на актуальность между добавлением в корзину и оформлением
   - При невалидном промокоде выбрасывается BadRequestException с понятным сообщением

2. ✅ **Уведомления о новых промокодах**
   - Интегрирован NotificationsService в PromoCodeTriggersService
   - При создании промокода через триггер отправляется push-уведомление
   - Создан компонент NewPromoCodeBanner для отображения новых промокодов в личном кабинете
   - Баннер показывает промокоды за последние 7 дней с возможностью закрыть

3. ✅ **История использования промокодов в админке**
   - Новый эндпоинт GET `/promo-codes/usage/all` для получения истории
   - Поддержка фильтров: promoCodeId, userId, orderId, dateFrom, dateTo
   - Пагинация результатов
   - Создана страница `/panel/promo-codes/usage` с:
     - Таблицей использований
     - Фильтрами по дате, пользователю, заказу
     - Статистикой: общее количество, сумма скидок, средняя скидка
     - Экспортом в CSV

#### Исправленные ошибки:

1. ✅ **Исправлены ошибки компиляции TypeScript в backend**
   - Исправлены имена сервисов (PromoCodeTriggersService → PromoCodeTriggersService)
   - Добавлены недостающие интерфейсы (RequestWithUser, OptionalJwtGuard)
   - Добавлено поле excludeFromPromoCodes в ProductDto
   - Исправлены проблемы с типами для валидации промокодов
   - Добавлены обязательные поля subtotalAmount и orderAmount

2. ✅ **Исправлены ошибки в frontend**
   - Создан компонент Select для Radix UI
   - Заменен дублирующий request.ts на использование существующего API клиента
   - Исправлена ошибка с таблицей промокодов (TanStack Table columns)
   - Добавлена поддержка авторизации для админских страниц промокодов
   - Создан отдельный клиентский API для промокодов
   - Добавлена пагинация в API промокодов на backend

#### Технические улучшения:

- Использование forwardRef для решения циклических зависимостей
- Правильная типизация для работы с Decimal в Prisma
- Синхронизация форматов данных между frontend и backend
- Следование паттернам проекта для UI компонентов

### Настройки магазина (2025-01-23)

#### Реализованные функции:

1. ✅ **Управление телефонами магазина**
   - Создана модель StorePhone с поддержкой WhatsApp и Telegram
   - CRUD API для управления телефонными номерами
   - Возможность указать основной номер и порядок сортировки
   - UI компоненты для добавления/редактирования/удаления телефонов
   - Отображение иконок WhatsApp и Telegram для соответствующих номеров

2. ✅ **Управление адресами магазина**
   - Создана модель StoreAddress для разных типов адресов (офис, склад, пункт самовывоза)
   - CRUD API для управления адресами
   - Поддержка GPS координат и часов работы
   - UI компоненты с табами для переключения между телефонами и адресами
   - Возможность деактивировать адреса без удаления

3. ✅ **Общие настройки магазина**
   - Создана модель StoreSettings для хранения произвольных настроек в JSON
   - API для получения и обновления настроек по ключу
   - Доступ к настройкам для ролей ADMIN и MANAGER

4. ✅ **Интеграция контактов во все разделы сайта**
   - Создан StoreContactsContext для централизованного управления контактами
   - Обновлен DesktopHeader для отображения телефонов и адреса из БД
   - Обновлен Footer с динамическими контактами и ссылками на мессенджеры
   - Обновлен PhoneModal для отображения всех телефонов с мессенджерами
   - Создана страница контактов с полной информацией
   - Delivery методы теперь используют актуальный адрес самовывоза

5. ✅ **Исправление позиционирования счетчиков в мобильном меню**
   - Улучшено позиционирование badge счетчиков (корзина, избранное, чат)
   - Использование абсолютного позиционирования с фиксированными контейнерами
   - Добавлен ring вместо border для лучшей визуальной интеграции
   - Оптимизирована верстка для предотвращения смещения элементов

6. ✅ **Исправление счетчика непрочитанных сообщений в чате**
   - Исправлена логика очистки счетчика при посещении страницы чата
   - Добавлен вызов API для пометки сообщений как прочитанных
   - Создан NotificationInitializer для корректной инициализации счетчиков
   - Обновлен NotificationContext для правильной работы с URL /chat
   - Добавлена синхронизация счетчика при навигации между страницами

#### Технические детали:

- Модели Prisma: StorePhone, StoreAddress, StoreSettings
- Backend модуль settings с полным набором DTO
- Frontend компоненты с использованием React Hook Form и Zod валидацией
- Интеграция с существующей системой авторизации
- Добавлена ссылка на настройки в админ панель
- Создан контекст StoreContactsContext для доступа к контактам
- Добавлены дефолтные контакты в seed.ts

### Страница статистики в админке (2025-01-23)

#### Реализованные функции:

1. ✅ **Backend модуль статистики**
   - Создан StatisticsModule с service и controller
   - Реализованы методы получения общей статистики (заказы, выручка, клиенты, товары)
   - Статистика по периодам с группировкой по дням, неделям и месяцам
   - Топ продаваемых товаров с детальной информацией
   - Статистика по статусам заказов и методам оплаты
   - Анализ новых клиентов с расчетом конверсии
   - Использование date-fns для работы с датами

2. ✅ **Frontend страница статистики**
   - Создана страница /panel/statistics с полным дашбордом
   - Компонент StatCard для отображения метрик
   - Динамическое переключение периодов (день/неделя/месяц)
   - Таблицы с топ товарами, статусами заказов, методами оплаты
   - Визуализация данных с цветовой индикацией статусов
   - Форматирование валюты и чисел для российского региона

3. ✅ **API интеграция**
   - Создан statistics.ts с типами и методами для frontend
   - Поддержка как серверных, так и клиентских запросов
   - Обработка параметров фильтрации (период, лимит, дни)
   - Правильная авторизация через Bearer токены

#### Технические детали:

- Использование Prisma aggregate и groupBy для эффективных запросов
- Параллельная загрузка данных через Promise.all
- Типизация с использованием Decimal из Prisma
- Доступ для ролей ADMIN и MANAGER
- Интеграция с существующей системой авторизации

### Исправление ошибок TypeScript в product images (2025-01-24)

#### Исправленные ошибки:

1. ✅ **Исправлена обработка body.isMain в uploadImage**
   - Добавлена правильная типизация для body.isMain как string | boolean
   - Реализована логика обработки обоих типов данных (multipart/form-data передает string)
   - Безопасное преобразование строкового значения 'true' в boolean

2. ✅ **Исправлена несовместимость типов для поля alt**
   - Обновлен ProductImageDto для поддержки alt как string | null (соответствует Prisma схеме)
   - Добавлено преобразование undefined в null при создании записи
   - Корректная обработка alt при обновлении изображения

#### Технические детали:

- Типизация соответствует поведению multipart/form-data
- Соблюдена совместимость с Prisma схемой (alt: String?)
- Добавлена nullable: true в ApiProperty для корректной документации Swagger

### Улучшения UI формы товара (2025-01-24)

#### Реализованные функции:

1. ✅ **Компонент поиска по категориям (CategorySearchSelect)**
   - Поисковая строка для фильтрации категорий в реальном времени
   - Отображение количества выбранных категорий
   - Показ пути к категории при поиске
   - Очистка поиска одним кликом
   - Сохранение иерархической структуры с отступами

2. ✅ **Менеджер изображений товара (ProductImagesManager)**
   - Drag-n-drop загрузка изображений
   - Перетаскивание для изменения порядка (dnd-kit)
   - Выбор главного изображения
   - Редактирование alt текста для SEO
   - Удаление изображений с подтверждением
   - Прогресс загрузки файлов
   - Предварительный просмотр для новых товаров
   - Интеграция с API для существующих товаров

3. ✅ **Обновление формы товара**
   - Добавлено поле "Старая цена" для отображения скидок
   - Интеграция CategorySearchSelect вместо простого списка
   - Интеграция ProductImagesManager вместо URL-инпутов
   - Поддержка работы с новым API изображений

#### Технические детали:

- Использование @dnd-kit для drag-n-drop функциональности
- Создан API клиент для product-images
- Поддержка локальных превью для новых товаров
- Автоматическая синхронизация с сервером для существующих товаров
- Обработка ошибок загрузки и валидация файлов

### Исправление загрузки изображений товаров (2025-06-24)

#### Исправленные ошибки:

1. ✅ **Удалено устаревшее поле images из процесса сохранения товара**
   - Поле images помечено как deprecated в backend
   - Изображения теперь управляются через отдельную таблицу ProductImage
   - Удалено поле images из CreateProductDto и UpdateProductDto на frontend
   - Удалено поле images из состояния формы ProductSheet
   - Убран неиспользуемый импорт getImageUrl

2. ✅ **Исправлено отображение изображений в ProductImagesManager**
   - Добавлено использование getImageUrl для преобразования относительных путей в полные URL
   - Учтена обработка временных blob URL для предпросмотра новых изображений
   - Исправлено затемнение изображений при наведении - кнопки теперь появляются без черного фона

3. ✅ **Проверена интеграция productImages в backend**
   - Все методы получения товаров (findAll, findBySlug, findById) включают productImages
   - Правильная сортировка изображений: сначала главное, затем по sortOrder
   - ProductDto включает поле productImages с типом ProductImageDto[]
   - mapToDto корректно преобразует данные изображений

4. ✅ **Обновлен список товаров в админке для отображения изображений**
   - Колонка "Фото" теперь использует поле productImages вместо устаревшего images
   - Автоматический выбор главного изображения (isMain: true) или первого доступного
   - Использование getImageUrl для преобразования относительных путей в полные URL
   - Показ заглушки "Нет фото" для товаров без изображений

5. ✅ **Обновлены компоненты отображения товаров на фронте**
   - ProductCard теперь использует productImages для карточек товаров
   - Страница товара обновлена для показа главного изображения и галереи
   - Правильная сортировка изображений: главное первым, затем по sortOrder
   - ProductImage уже использовал getImageUrl для преобразования URL

6. ✅ **Реализована интерактивная галерея изображений товара**
   - Создан компонент ProductImageGallery с функциональностью:
     - Переключение главного изображения по клику на миниатюры
     - Подсветка активной миниатюры
     - Открытие полноэкранной галереи (lightbox) по клику на главное изображение
     - Навигация по изображениям стрелками (кнопки и клавиатура)
     - Счетчик изображений в модальном окне
     - Закрытие по Escape или клику вне изображения
   - Исправления:
     - Добавлен скрытый DialogTitle для доступности
     - Изменен фон модального окна на светлый с размытием
     - Добавлена кнопка закрытия (X) в правом верхнем углу
     - Улучшен стиль навигационных кнопок
     - Убран дублирующийся крестик через showCloseButton={false}
     - Увеличен размер модального окна до 95% экрана
     - Исправлено масштабирование изображений при переключении в галерее

#### Технические детали:

- Изображения загружаются через отдельный эндпоинт `/products/{id}/images/upload`
- При загрузке изображение сразу сохраняется в БД и привязывается к товару
- Нет необходимости отправлять массив images при создании/обновлении товара
- Архитектура позволяет управлять изображениями независимо от товара
- Кнопки управления изображениями отображаются в правом верхнем углу без затемнения

### Улучшения управления брендами в форме товара (2025-06-24)

#### Реализованные функции:

1. ✅ **Компонент BrandCombobox с поиском и фильтрацией**
   - Заменен простой select на combobox из shadcn/ui
   - Добавлен поиск/фильтрация брендов по названию
   - Отображение страны происхождения и количества товаров
   - Возможность выбрать "Без бренда"

2. ✅ **Возможность создания бренда прямо из формы товара**
   - Кнопка "Добавить новый бренд" в нижней части списка
   - Автоматическое создание бренда при поиске несуществующего
   - Диалоговое окно с формой создания бренда
   - Поля: название, slug, страна, описание
   - Автоматическая генерация slug по названию
   - После создания бренд автоматически выбирается в форме

3. ✅ **Интеграция с существующей системой**
   - Использование существующего API для создания брендов
   - Обновление списка брендов после создания нового
   - Сохранение контекста авторизации
   - Валидация и обработка ошибок

4. ✅ **Исправление проблемы с вложенными формами**
   - Добавлены обработчики stopPropagation для предотвращения отправки родительской формы
   - Форма создания бренда полностью изолирована от формы товара
   - Исправлена высота селекта бренда для соответствия другим полям (42px)

#### Технические детали:

- Установлены компоненты shadcn/ui: command, popover
- Создан компонент BrandCombobox в /frontend/components/admin/products/
- Интеграция с ProductSheet без изменения логики сохранения товара
- Использование React hooks для управления состоянием
- Поддержка клавиатурной навигации в combobox

### Система характеристик товаров (2025-06-24)

#### Реализованные функции:

1. ✅ **Компонент ProductAttributes для управления характеристиками**
   - Динамическая загрузка характеристик при выборе категорий
   - Поддержка всех типов атрибутов: TEXT, NUMBER, COLOR, SELECT_ONE, SELECT_MANY
   - Группировка по обязательным и дополнительным характеристикам
   - Автоматическое сохранение значений при изменении

2. ✅ **Типы полей для разных атрибутов**
   - TEXT: многострочное текстовое поле (Textarea)
   - NUMBER: числовое поле с поддержкой единиц измерения
   - COLOR: выбор цвета с HEX инпутом
   - SELECT_ONE: выпадающий список для выбора одного значения
   - SELECT_MANY: чекбоксы для выбора нескольких значений

3. ✅ **Интеграция с формой товара**
   - Загрузка существующих значений атрибутов при редактировании
   - Сохранение атрибутов вместе с товаром через bulk API
   - Обновление атрибутов при изменении категорий
   - Отображение подсказки о необходимости выбрать категории

4. ✅ **API для работы с атрибутами**
   - Восстановлен оригинальный файл attributes.ts с правильными типами
   - Добавлен метод getAttributesByCategoryIds для множественных категорий
   - Поддержка фильтрации и сортировки атрибутов
   - Правильная обработка авторизации для всех методов

#### Технические детали:

- Использование динамического импорта для избежания циклических зависимостей
- Компонент ProductAttributes в /frontend/components/admin/products/
- Интеграция с существующей системой атрибутов в backend
- Дедупликация атрибутов при выборе нескольких категорий
- Приоритет обязательных атрибутов при конфликтах

### Добавлена возможность загрузки файла логотипа для брендов (2025-06-24)

#### Реализованные функции:

1. ✅ **Backend endpoint для загрузки логотипа**
   - Создан новый endpoint `POST /brands/:id/logo/upload` для загрузки логотипа бренда
   - Настроен Multer для обработки файлов с сохранением в директорию `uploads/brands/`
   - Добавлена валидация типов файлов (JPEG, PNG, GIF, WebP) и размера (до 10MB)
   - Автоматическое создание директории для загрузок
   - Генерация уникальных имен файлов с временной меткой
  
2. ✅ **Frontend компонент для загрузки**
   - Обновлен компонент `BrandSheet` для поддержки загрузки файлов
   - Добавлен визуальный интерфейс с drag-and-drop областью
   - Реализован предпросмотр загружаемого изображения
   - Возможность удаления выбранного изображения
   - Сохранена возможность указания URL логотипа как альтернатива
   - Индикация процесса загрузки файла

3. ✅ **API интеграция**
   - Добавлена функция `uploadLogo` в API клиент брендов
   - Поддержка загрузки через FormData
   - Правильная обработка авторизации
   - Двухэтапное сохранение: сначала создание/обновление бренда, затем загрузка логотипа

#### Технические детали:

- Использование FileInterceptor от @nestjs/platform-express
- Валидация MIME типов на сервере для безопасности
- Клиентская валидация размера и типа файла
- Поддержка всех популярных форматов изображений
- Файлы доступны по пути `/uploads/brands/[filename]`

### Улучшения карточки товара (2025-06-24)

#### Реализованные функции:

1. ✅ **Добавлено поле для исключения товара из промокодов**
   - Добавлено поле `excludeFromPromoCodes` в интерфейсы Product, CreateProductDto и UpdateProductDto
   - Добавлен чекбокс "Исключить из промокодов" в форму товара
   - Поле сохраняется при создании и редактировании товара
   - Расположено рядом с чекбоксом "Товар активен"

2. ✅ **Система связывания товаров с марками/моделями автомобилей**
   - Создан компонент `VehicleMakeMultiSelect` для множественного выбора марок автомобилей
   - Отображение выбранных марок в виде тегов с возможностью удаления
   - Создан компонент `VehicleModelsSelector` с расширенным функционалом:
     - Группировка моделей по маркам с разворачиваемыми списками
     - Для каждой модели можно указать годы выпуска (от/до)
     - Поле для примечаний по совместимости (например, "только для дизельных двигателей")
     - Чекбокс "Универсальная запчасть" для всех модификаций
   - Интеграция в форму товара с автоматическим сохранением привязок
   - Загрузка существующих привязок при редактировании товара
   - Использование API `productVehiclesApi.bulkCreate()` для массового сохранения

#### Технические детали:

- Компоненты находятся в `/frontend/components/admin/products/`
- Поддержка множественного выбора марок автомобилей
- Ленивая загрузка моделей при развертывании марки
- Валидация годов выпуска с учетом ограничений модели
- Автоматическое определение марок из существующих привязок товара
- Дефолтные значения годов берутся из характеристик модели

### Карточка помощи эксперта в списках товаров (2025-06-24)

#### Реализованные функции:

1. ✅ **Создан компонент ExpertHelpCard**
   - Карточка с призывом обратиться к экспертам за помощью
   - Информация о быстрой доставке (от 1 дня) и лучшей цене
   - Кнопка открытия чата с экспертом
   - Стилизация похожая на обычные карточки товаров

2. ✅ **Интеграция в страницы каталога**
   - Добавлена карточка в конец списка товаров в категориях
   - Отображается при пустых результатах вместе с EmptyCategory
   - Интегрирована в страницу поиска товаров
   - Добавлена на страницу модели автомобиля

#### Технические детали:

- Компонент использует `useChatStore` для открытия чата
- Клиентский компонент для интерактивности
- Единообразное отображение во всех списках товаров
- Адаптивная верстка для мобильных устройств

### Управление пользователями и анонимными пользователями (2025-06-25)

#### Реализованные функции:

1. ✅ **Добавлена Яндекс Метрика**
   - Создан компонент YandexMetrika с ID счетчика 103007204
   - Интегрирован в корневой layout приложения
   - Включены: clickmap, trackLinks, accurateTrackBounce, webvisor

2. ✅ **Исправлено отображение изображений на странице заказа**
   - Добавлено использование getImageUrl для изображений товаров
   - Исправлено отображение изображений в личном кабинете на странице заказа

3. ✅ **Синхронизирована страница создания товара**
   - Страница /panel/products/new теперь использует ProductSheet компонент
   - Унифицирован интерфейс создания товара с модальным окном

4. ✅ **Реализовано редактирование товарных предложений в чате**
   - Добавлена функциональность редактирования существующих предложений
   - Кнопка в диалоге товарного предложения меняет текст на "Обновить предложение"
   - Сохраняется ID редактируемого предложения

5. ✅ **Управление анонимными пользователями**
   - Создан backend модуль для анонимных пользователей
   - Реализованы endpoints для получения списка с пагинацией и фильтрацией
   - Добавлены вкладки в разделе пользователей: зарегистрированные и анонимные
   - Создан компонент AdminAnonymousUsersList с таблицей
   - Отображается информация: токен, последняя активность, количество товаров в корзине/избранном/чатах

6. ✅ **Страница профиля пользователя**
   - Создана отдельная страница профиля вместо модального окна
   - Добавлены вкладки: профиль, заказы, корзина, избранное, чаты, анонимные пользователи
   - Реализованы компоненты для каждой вкладки с загрузкой соответствующих данных
   - Обновлен список пользователей - теперь клик ведет на страницу профиля

7. ✅ **API для связанных данных пользователя**
   - Добавлены endpoints: /users/:id/cart, /users/:id/favorites, /users/:id/chats, /users/:id/anonymous-users
   - Обновлен users.service для включения связанных анонимных пользователей
   - Добавлена интеграция с сервисами Cart, Favorites и Chats через forwardRef
   - Создан метод getUserAnonymousUsers для получения связанных анонимных сессий

8. ✅ **Исправление валидации email при сохранении пользователя**
   - Добавлено преобразование пустых строк в undefined перед сохранением
   - Исправлена ошибка "email must be an email" для пустых значений
   - Обновлены методы create и update в users.service
   - Обновлены компоненты UserProfileTab и UserSheet на frontend

#### Технические детали:

- Использование forwardRef для предотвращения циклических зависимостей между модулями
- Правильная типизация для работы с Prisma (например, преобразование null в undefined)
- Интеграция с существующей системой авторизации
- Поддержка ролей ADMIN и MANAGER для доступа к данным пользователей

## TODO

- [ ] Тестирование всех реализованных функций
- [ ] Оптимизация производительности запросов
- [ ] Добавление unit тестов для новых функций
- [ ] Добавить графики для визуализации статистики
- [ ] Экспорт статистики в Excel/PDF