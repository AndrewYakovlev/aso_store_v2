# Progress & TODO

Этот файл используется для отслеживания прогресса разработки интернет-магазина АСО и планирования задач.

## Completed Tasks

### Initial Setup (2024-06-17)
- ✅ Создана структура монорепозитория
- ✅ Инициализирован корневой package.json с npm workspaces
- ✅ Установлен и настроен NestJS 11 для backend
- ✅ Установлен и настроен Next.js 15 для frontend  
- ✅ Настроены скрипты для запуска проектов
- ✅ Инициализирован Git репозиторий
- ✅ Создан .gitignore файл
- ✅ Создан CLAUDE.md с инструкциями для будущей разработки
- ✅ Создан progress.md для отслеживания задач

### Backend Infrastructure (2024-06-17)
- ✅ Установлен Prisma ORM и PostgreSQL драйвер
- ✅ Создан Prisma сервис в NestJS (глобальный модуль)
- ✅ Установлен и настроен Swagger для API документации
- ✅ Установлены зависимости для JWT авторизации (passport, passport-jwt)
- ✅ Установлены и настроены пакеты для валидации (class-validator, class-transformer)
- ✅ Настроен CORS для режима разработки (разрешены все источники)
- ✅ Создана базовая схема БД в Prisma с моделями:
  - User (поддержка анонимных и авторизованных)
  - Session (для управления сессиями)
  - Category (иерархическая структура)
  - Product с Specification
  - Vehicle (Brand, Model, Generation)
  - Cart и CartItem
  - Favorite
  - Order с динамическими статусами
  - DeliveryMethod и PaymentMethod (управляемые)
  - Chat и ProductOffer
- ✅ Создан .env.example файл

### Frontend UI Setup (2024-06-17)
- ✅ Добавлены иконки и логотип проекта в структуру Next.js
- ✅ Создан компонент Logo для использования в приложении
- ✅ Обновлен layout с логотипом в header
- ✅ Настроены favicon и иконки для всех платформ
- ✅ Создан manifest.json для PWA поддержки
- ✅ Исправлена проблема с импортами в Next.js 15
- ✅ Установлены @heroicons/react для иконок интерфейса
- ✅ Создан адаптивный компонент Header с mobile-first подходом:
  - Мобильная версия: меню, логотип, телефон, личный кабинет
  - Планшетная версия: добавлен адрес и номер телефона
  - Десктопная версия: верхнее меню, каталог, поиск, избранное, корзина
- ✅ Интегрирован Header в основной layout
- ✅ Созданы заглушки для всех страниц (каталог, о компании, контакты, корзина)

### Database Updates (2025-06-17)
- ✅ Обновлена схема БД:
  - Удален isAnonymous из модели User
  - Создана отдельная модель AnonymousUser
  - Добавлена модель OtpCode для SMS верификации
  - Обновлены связи Cart, Favorite, Chat для поддержки обоих типов пользователей
  - Добавлены необязательные поля firstName, lastName, middleName к User

### Product Catalog Implementation (2025-06-17)
- ✅ Backend реализация каталога товаров:
  - Обновлена схема БД для поддержки множественных категорий у товаров
  - Создан модуль categories с иерархической структурой
  - Создан модуль products с полным CRUD функционалом
  - API endpoints с пагинацией, фильтрацией по категориям
  - Поддержка сортировки и поиска по названию/артикулу
  - Swagger документация для всех endpoints
- ✅ Frontend реализация каталога:
  - API клиент для работы с товарами и категориями
  - Компоненты ProductCard, ProductsGrid, ProductsPagination
  - Страница каталога с категориями и товарами
  - Детальная страница товара
  - SEO-оптимизированные серверные компоненты

### Favorites Implementation (2025-06-17)
- ✅ Backend модуль избранного:
  - Поддержка анонимных и авторизованных пользователей
  - API endpoints: добавление, удаление, получение списка
  - Автоматическое слияние при регистрации анонимного пользователя
  - Использование forwardRef для решения циклических зависимостей
  - ⚠️ ИСПРАВЛЕНО: Проблема с общим избранным для всех пользователей (неправильное извлечение userId/anonymousUserId)
- ✅ Frontend функционал избранного:
  - Hook useFavorites с оптимистичными обновлениями
  - FavoritesContext для глобального состояния
  - Интеграция в ProductCard и страницу товара
  - Страница избранного с отображением товаров
  - Счетчик избранного в Header
  - Полная поддержка React 19 и Next.js 15

### Shopping Cart Implementation (2025-06-17)
- ✅ Backend модуль корзины:
  - Создан CartModule с полным CRUD функционалом
  - DTOs для добавления товаров, обновления количества, получения сводки
  - CartService с поддержкой анонимных и авторизованных пользователей
  - Автоматическое создание корзины при первом добавлении
  - Проверка наличия товара на складе
  - Слияние корзин при регистрации анонимного пользователя
  - Интеграция с AuthService через forwardRef
  - ⚠️ ИСПРАВЛЕНО: Проблема с неправильным извлечением userId/anonymousUserId из req.user
- ✅ Frontend функционал корзины:
  - API клиент для всех операций с корзиной
  - Hook useCart с оптимистичными обновлениями
  - CartContext для глобального состояния корзины
  - Интеграция в ProductCard и ProductActions
  - Полноценная страница корзины с управлением товарами
  - Счетчик товаров в Header
  - Возможность изменения количества и удаления товаров
  - Отображение итоговой суммы
- ✅ Исправления TypeScript ошибок:
  - Добавлена проверка на null для cartItem.product
  - Удалены несуществующие поля oldPrice и barcode из ProductDto

### Authentication System (2025-06-17)
- ✅ Реализован модуль авторизации на backend:
  - JWT сервис с тремя типами токенов (access, refresh, anonymous)
  - Anonymous user service для создания и управления анонимными пользователями
  - Auth controller с endpoints для анонимных токенов
  - Настроены JWT стратегии для passport
  - Токены анонимных пользователей живут 365 дней
  - OTP сервис с поддержкой 5 попыток ввода кода
  - Автоматическое создание пользователя при первой отправке OTP
  - Слияние данных анонимного пользователя при авторизации
- ✅ Реализована система анонимных токенов на frontend:
  - Route Handler `/api/auth/anonymous` для управления токенами
  - Синхронизация между httpOnly cookies и localStorage
  - AnonymousTokenProvider для автоматической инициализации
  - useAnonymousToken hook для React компонентов
  - Middleware для добавления токенов в заголовки запросов
  - API клиент с автоматической поддержкой токенов
- ✅ Реализована двухшаговая авторизация на frontend:
  - Установлен и настроен shadcn/ui для Next.js 15
  - Создан кастомный компонент PhoneInput с маской (React 19 совместимый)
  - Компонент AuthForm с вводом телефона и OTP кода
  - Использован input-otp для ввода 6-значного кода
  - AuthModal для модального окна авторизации
  - AuthContext для управления состоянием пользователя
  - Интеграция в Header с отображением статуса
  - Страница личного кабинета с профилем пользователя
  - В dev режиме OTP код отображается в форме

## TODO - High Priority

### Backend Infrastructure
- [x] Установить и настроить PostgreSQL
- [x] Установить и настроить Prisma ORM
- [x] Создать базовую схему БД (users, sessions, products, carts, orders)
- [x] Настроить Swagger для API документации
- [x] Настроить CORS для режима разработки
- [x] Реализовать JWT авторизацию
- [x] Создать систему анонимных сессий

### Frontend Infrastructure
- [x] Настроить структуру папок и компонентов
- [x] Установить и настроить axios/fetch wrapper для API
- [x] Создать базовые layouts (главная, каталог, личный кабинет)
- [x] Настроить систему роутинга
- [ ] Реализовать state management для корзины и пользователя

### Authentication & Users
- [ ] SMS провайдер для отправки кодов
- [x] API endpoints для анонимных токенов
- [x] API endpoints для регистрации/авторизации по SMS
- [x] Миграция анонимной сессии к пользователю
- [x] Личный кабинет пользователя

## TODO - Medium Priority

### Product Catalog
- [ ] Модель данных для категорий (иерархическая)
- [ ] Модель данных для товаров с характеристиками
- [ ] Связь товаров с марками/моделями авто
- [ ] API для каталога с фильтрацией и пагинацией
- [ ] UI каталога с фильтрами
- [ ] Поиск по товарам

### Shopping Features
- [ ] Корзина (backend + frontend)
- [x] Избранное (backend + frontend) ✅ (2025-06-17)
  - Создан backend модуль с поддержкой анонимных и авторизованных пользователей
  - API endpoints для добавления/удаления/получения избранного
  - Frontend hook useFavorites с оптимистичными обновлениями
  - FavoritesContext для глобального состояния
  - Интеграция в ProductCard и страницу товара
  - Страница избранного с отображением товаров
  - Счетчик избранного в Header
  - Автоматическое слияние при регистрации анонимного пользователя
- [ ] Сравнение товаров

### Orders
- [ ] Управляемые статусы заказов (admin panel)
- [ ] Методы доставки (настраиваемые)
- [ ] Методы оплаты (настраиваемые)
- [ ] Оформление заказа (checkout flow)
- [ ] История заказов

## TODO - Low Priority

### Expert Chat System
- [ ] WebSocket сервер для real-time чата
- [ ] Модель данных для чатов и сообщений
- [ ] UI чата для клиентов
- [ ] Интерфейс менеджера для чатов
- [ ] Товарные предложения (ProductOffers)
- [ ] Интеграция товарных предложений с корзиной

### Admin Panel
- [ ] Управление товарами
- [ ] Управление заказами
- [ ] Управление пользователями
- [ ] Настройки магазина (статусы, доставка, оплата)
- [ ] Статистика и аналитика

### Performance & Optimization
- [ ] Redis для кеширования
- [ ] Оптимизация изображений
- [ ] CDN интеграция
- [ ] SEO оптимизация
- [ ] PWA функционал

## Notes & Decisions

### Архитектурные решения
- Используем анонимные сессии для улучшения UX - пользователи могут добавлять в корзину без регистрации
- Товарные предложения - отдельная сущность для гибкости в чатах с менеджерами
- Управляемые статусы/методы доставки/оплаты для масштабируемости бизнеса

### Технические заметки
- Prisma выбрана для type-safety и удобства миграций
- SMS авторизация вместо email для упрощения процесса
- WebSockets для чата вместо polling для real-time опыта

## Current Sprint Focus

Текущий фокус: базовая инфраструктура и UI компоненты
1. ✅ PostgreSQL + Prisma setup
2. ✅ Базовая схема БД
3. ✅ Swagger документация
4. ✅ Базовые UI компоненты (Header, Logo)
5. ✅ JWT авторизация + анонимные сессии
6. ✅ Система анонимных токенов (backend + frontend)
7. ✅ Двухшаговая авторизация по SMS
8. ✅ Личный кабинет пользователя
9. ✅ Каталог товаров (backend + frontend)
10. ✅ Избранное (backend + frontend)
11. ✅ Корзина покупок (backend + frontend)
12. ✅ Исправлены критические ошибки с изоляцией данных пользователей

### Критические исправления (2025-06-18)
- Исправлена проблема с общим избранным для всех пользователей
- Исправлена проблема с общей корзиной для всех пользователей  
- Обновлены контроллеры для правильного извлечения userId/anonymousUserId
- Добавлена передача анонимного токена в API запросах на frontend
- Улучшена валидация в сервисах для предотвращения создания записей без привязки к пользователю
- Исправлена проблема с httpOnly cookies - добавлены клиентские cookies для доступа из JavaScript
- API клиент теперь читает токен из localStorage или клиентских cookies
- Убрано лишнее логирование из кода

### Orders System Implementation (2025-06-18)
- ✅ Backend модуль заказов:
  - Обновлена схема БД для поддержки анонимных заказов
  - Добавлены поля для контактной информации и адреса доставки
  - Создан OrdersModule с полным CRUD функционалом
  - DTOs для создания заказа, обновления статуса, фильтрации
  - OrdersService с генерацией номера заказа
  - Поддержка динамических статусов, методов доставки и оплаты
  - API endpoints для управления заказами
  - Автоматическая очистка корзины после создания заказа
  - ⚠️ ВАЖНОЕ ИЗМЕНЕНИЕ: Заказы теперь требуют обязательной регистрации
- ✅ Frontend система заказов:
  - API клиент для работы с заказами
  - Страница оформления заказа с формами:
    - Контактная информация
    - Выбор способа доставки
    - Адрес доставки (условно)
    - Выбор способа оплаты
    - Комментарий к заказу
  - Валидация форм на клиенте
  - Страница успешного оформления заказа
  - Страница истории заказов с фильтрацией по статусам
  - Страница детального просмотра заказа
  - Интеграция с личным кабинетом
  - ✅ Встроенная аутентификация в процесс оформления заказа:
    - Компонент AuthStep для подтверждения телефона
    - Скрытая регистрация - номер телефона запрашивается как часть формы
    - Автоматическое подтверждение через SMS код
    - Блокировка оформления заказа до подтверждения телефона
    - Обновление схемы БД - userId теперь обязателен для заказов

Следующие шаги:
    - Поиск и фильтрация товаров
    - Связь товаров с автомобилями
    - SMS провайдер для production
    - Чат с экспертом
    - Товарные предложения от менеджеров