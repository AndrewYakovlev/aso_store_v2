# Progress Log

## Выполненные задачи

### Улучшения системы промокодов (2025-06-21)

#### Реализованные функции:

1. ✅ **Проверка истечения срока действия промокода при оформлении заказа**
   - Добавлена повторная валидация промокода перед созданием заказа в `orders.service.ts`
   - Промокод проверяется на актуальность между добавлением в корзину и оформлением
   - При невалидном промокоде выбрасывается BadRequestException с понятным сообщением

2. ✅ **Уведомления о новых промокодах**
   - Интегрирован NotificationsService в PromoCodeTriggersService
   - При создании промокода через триггер отправляется push-уведомление
   - Создан компонент NewPromoCodeBanner для отображения новых промокодов в личном кабинете
   - Баннер показывает промокоды за последние 7 дней с возможностью закрыть

3. ✅ **История использования промокодов в админке**
   - Новый эндпоинт GET `/promo-codes/usage/all` для получения истории
   - Поддержка фильтров: promoCodeId, userId, orderId, dateFrom, dateTo
   - Пагинация результатов
   - Создана страница `/panel/promo-codes/usage` с:
     - Таблицей использований
     - Фильтрами по дате, пользователю, заказу
     - Статистикой: общее количество, сумма скидок, средняя скидка
     - Экспортом в CSV

#### Исправленные ошибки:

1. ✅ **Исправлены ошибки компиляции TypeScript в backend**
   - Исправлены имена сервисов (PromoCodeTriggersService → PromoCodeTriggersService)
   - Добавлены недостающие интерфейсы (RequestWithUser, OptionalJwtGuard)
   - Добавлено поле excludeFromPromoCodes в ProductDto
   - Исправлены проблемы с типами для валидации промокодов
   - Добавлены обязательные поля subtotalAmount и orderAmount

2. ✅ **Исправлены ошибки в frontend**
   - Создан компонент Select для Radix UI
   - Заменен дублирующий request.ts на использование существующего API клиента
   - Исправлена ошибка с таблицей промокодов (TanStack Table columns)
   - Добавлена поддержка авторизации для админских страниц промокодов
   - Создан отдельный клиентский API для промокодов
   - Добавлена пагинация в API промокодов на backend

#### Технические улучшения:

- Использование forwardRef для решения циклических зависимостей
- Правильная типизация для работы с Decimal в Prisma
- Синхронизация форматов данных между frontend и backend
- Следование паттернам проекта для UI компонентов

## TODO

- [ ] Тестирование всех реализованных функций
- [ ] Оптимизация производительности запросов
- [ ] Добавление unit тестов для новых функций