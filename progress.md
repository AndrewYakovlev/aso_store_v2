# Progress Log

## Выполненные задачи

### Улучшения системы промокодов (2025-06-21)

#### Реализованные функции:

1. ✅ **Проверка истечения срока действия промокода при оформлении заказа**
   - Добавлена повторная валидация промокода перед созданием заказа в `orders.service.ts`
   - Промокод проверяется на актуальность между добавлением в корзину и оформлением
   - При невалидном промокоде выбрасывается BadRequestException с понятным сообщением

2. ✅ **Уведомления о новых промокодах**
   - Интегрирован NotificationsService в PromoCodeTriggersService
   - При создании промокода через триггер отправляется push-уведомление
   - Создан компонент NewPromoCodeBanner для отображения новых промокодов в личном кабинете
   - Баннер показывает промокоды за последние 7 дней с возможностью закрыть

3. ✅ **История использования промокодов в админке**
   - Новый эндпоинт GET `/promo-codes/usage/all` для получения истории
   - Поддержка фильтров: promoCodeId, userId, orderId, dateFrom, dateTo
   - Пагинация результатов
   - Создана страница `/panel/promo-codes/usage` с:
     - Таблицей использований
     - Фильтрами по дате, пользователю, заказу
     - Статистикой: общее количество, сумма скидок, средняя скидка
     - Экспортом в CSV

#### Исправленные ошибки:

1. ✅ **Исправлены ошибки компиляции TypeScript в backend**
   - Исправлены имена сервисов (PromoCodeTriggersService → PromoCodeTriggersService)
   - Добавлены недостающие интерфейсы (RequestWithUser, OptionalJwtGuard)
   - Добавлено поле excludeFromPromoCodes в ProductDto
   - Исправлены проблемы с типами для валидации промокодов
   - Добавлены обязательные поля subtotalAmount и orderAmount

2. ✅ **Исправлены ошибки в frontend**
   - Создан компонент Select для Radix UI
   - Заменен дублирующий request.ts на использование существующего API клиента
   - Исправлена ошибка с таблицей промокодов (TanStack Table columns)
   - Добавлена поддержка авторизации для админских страниц промокодов
   - Создан отдельный клиентский API для промокодов
   - Добавлена пагинация в API промокодов на backend

#### Технические улучшения:

- Использование forwardRef для решения циклических зависимостей
- Правильная типизация для работы с Decimal в Prisma
- Синхронизация форматов данных между frontend и backend
- Следование паттернам проекта для UI компонентов

### Настройки магазина (2025-01-23)

#### Реализованные функции:

1. ✅ **Управление телефонами магазина**
   - Создана модель StorePhone с поддержкой WhatsApp и Telegram
   - CRUD API для управления телефонными номерами
   - Возможность указать основной номер и порядок сортировки
   - UI компоненты для добавления/редактирования/удаления телефонов
   - Отображение иконок WhatsApp и Telegram для соответствующих номеров

2. ✅ **Управление адресами магазина**
   - Создана модель StoreAddress для разных типов адресов (офис, склад, пункт самовывоза)
   - CRUD API для управления адресами
   - Поддержка GPS координат и часов работы
   - UI компоненты с табами для переключения между телефонами и адресами
   - Возможность деактивировать адреса без удаления

3. ✅ **Общие настройки магазина**
   - Создана модель StoreSettings для хранения произвольных настроек в JSON
   - API для получения и обновления настроек по ключу
   - Доступ к настройкам для ролей ADMIN и MANAGER

4. ✅ **Интеграция контактов во все разделы сайта**
   - Создан StoreContactsContext для централизованного управления контактами
   - Обновлен DesktopHeader для отображения телефонов и адреса из БД
   - Обновлен Footer с динамическими контактами и ссылками на мессенджеры
   - Обновлен PhoneModal для отображения всех телефонов с мессенджерами
   - Создана страница контактов с полной информацией
   - Delivery методы теперь используют актуальный адрес самовывоза

5. ✅ **Исправление позиционирования счетчиков в мобильном меню**
   - Улучшено позиционирование badge счетчиков (корзина, избранное, чат)
   - Использование абсолютного позиционирования с фиксированными контейнерами
   - Добавлен ring вместо border для лучшей визуальной интеграции
   - Оптимизирована верстка для предотвращения смещения элементов

6. ✅ **Исправление счетчика непрочитанных сообщений в чате**
   - Исправлена логика очистки счетчика при посещении страницы чата
   - Добавлен вызов API для пометки сообщений как прочитанных
   - Создан NotificationInitializer для корректной инициализации счетчиков
   - Обновлен NotificationContext для правильной работы с URL /chat
   - Добавлена синхронизация счетчика при навигации между страницами

#### Технические детали:

- Модели Prisma: StorePhone, StoreAddress, StoreSettings
- Backend модуль settings с полным набором DTO
- Frontend компоненты с использованием React Hook Form и Zod валидацией
- Интеграция с существующей системой авторизации
- Добавлена ссылка на настройки в админ панель
- Создан контекст StoreContactsContext для доступа к контактам
- Добавлены дефолтные контакты в seed.ts

### Страница статистики в админке (2025-01-23)

#### Реализованные функции:

1. ✅ **Backend модуль статистики**
   - Создан StatisticsModule с service и controller
   - Реализованы методы получения общей статистики (заказы, выручка, клиенты, товары)
   - Статистика по периодам с группировкой по дням, неделям и месяцам
   - Топ продаваемых товаров с детальной информацией
   - Статистика по статусам заказов и методам оплаты
   - Анализ новых клиентов с расчетом конверсии
   - Использование date-fns для работы с датами

2. ✅ **Frontend страница статистики**
   - Создана страница /panel/statistics с полным дашбордом
   - Компонент StatCard для отображения метрик
   - Динамическое переключение периодов (день/неделя/месяц)
   - Таблицы с топ товарами, статусами заказов, методами оплаты
   - Визуализация данных с цветовой индикацией статусов
   - Форматирование валюты и чисел для российского региона

3. ✅ **API интеграция**
   - Создан statistics.ts с типами и методами для frontend
   - Поддержка как серверных, так и клиентских запросов
   - Обработка параметров фильтрации (период, лимит, дни)
   - Правильная авторизация через Bearer токены

#### Технические детали:

- Использование Prisma aggregate и groupBy для эффективных запросов
- Параллельная загрузка данных через Promise.all
- Типизация с использованием Decimal из Prisma
- Доступ для ролей ADMIN и MANAGER
- Интеграция с существующей системой авторизации

## TODO

- [ ] Тестирование всех реализованных функций
- [ ] Оптимизация производительности запросов
- [ ] Добавление unit тестов для новых функций
- [ ] Добавить графики для визуализации статистики
- [ ] Экспорт статистики в Excel/PDF